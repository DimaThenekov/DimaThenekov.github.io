<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WebKumir</title>
	<link rel="shortcut icon" type="image/x-icon" href="tileset/favicon.ico" />
	<link rel="icon" type="image/x-icon" href="tileset/favicon.ico" />
	<script type="text/javascript">
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
		(function() {
			var lastTime = 0;
			var vendors = ['webkit', 'moz'];
			for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
				window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
				window.cancelAnimationFrame =
				  window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
			}

			if (!window.requestAnimationFrame)
				window.requestAnimationFrame = function(callback, element) {
					var currTime = new Date().getTime();
					var timeToCall = Math.max(0, 16 - (currTime - lastTime));
					var id = window.setTimeout(function() { callback(currTime + timeToCall); },
					  timeToCall);
					lastTime = currTime + timeToCall;
					return id;
				};

			if (!window.cancelAnimationFrame)
				window.cancelAnimationFrame = function(id) {
					clearTimeout(id);
				};
		}());
		function getPosition(e) {
			var rect = e.target.getBoundingClientRect();
			var x = -1;
			var y = -1;
			if ((e.clientX != undefined) && (e.clientX != undefined)) {
				x = e.clientX - rect.left;
				y = e.clientY - rect.top;
			} else
				if (e.touches != undefined)
					if (e.touches.length > 0) {
						x = e.touches[0].clientX - rect.left;
						y = e.touches[0].clientY - rect.top;
					} else if (e.changedTouches.length > 0) {
						x = e.changedTouches[0].clientX - rect.left;
						y = e.changedTouches[0].clientY - rect.top;
					}
			return (x + ':' + y);
		}
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library
//library---library---library---library---library---library---library

		var pos_text, canvas, ctx;
		var onen=10n**30n;
		var posX = 5n*onen/10n, posY = 5n*onen/10n, posZ = onen;
		
		function onload()
		{
			pos_text=document.getElementById('pos_text');
			canvas=document.getElementById('canvas');
			ctx = canvas.getContext("2d", { alpha: false,antialias: false, depth: false,desynchronized:true});			
			
			
			canvas.addEventListener('mousemove', mouse_move);
			canvas.addEventListener("touchmove", mouse_move);
			canvas.addEventListener('mousedown', mouse_down);
			canvas.addEventListener("touchstart", mouse_down);
			canvas.addEventListener('mouseup', mouse_up);
			canvas.addEventListener("touchend", mouse_up);
			canvas.addEventListener('mouseout', mouse_up);
			canvas.addEventListener("touchcancel", mouse_up);

			if (canvas.addEventListener) {
				if ('onwheel' in document) {
					// IE9+, FF17+, Ch31+
					canvas.addEventListener("wheel", mouse_wheel);
				} else if ('onmousewheel' in document) {
					// устаревший вариант события
					canvas.addEventListener("mousewheel", mouse_wheel);
				} else {
					// Firefox < 17
					canvas.addEventListener("MozMousePixelScroll", mouse_wheel);
				}
			} else { // IE8-
				canvas.attachEvent("onmousewheel", mouse_wheel);
			}
			
			pr_pos();
			requestAnimationFrame(render);
		}
		var mousestatus = false;
		var mouselastX = 0;
		var mouselastY = 0;
		var scale=1n;
		function mouse_wheel(e) {
			e = e || window.event;
			var delta = e.deltaY || e.detail || e.wheelDelta;
			var ua = navigator.userAgent;
			
			if (ua.search(/Chrome/) > 0)
				delta=-delta;
			if (delta<0)
				posZ=posZ*100n/75n;
			else
				posZ=posZ*75n/100n;
			if (posZ>5n*onen)
			  posZ=5n*onen;
			while (posZ<10n**20n)
			{
				onen*=10n;
				posX*=10n;
				posY*=10n;
				posZ*=10n;
			}
			pr_pos();
			e.preventDefault ? e.preventDefault() : (e.returnValue = false);
		}
		function mouse_down(e)
		{
			mousestatus = true;
			mouselastX = parseFloat(getPosition(e).split(':')[0]);
			mouselastY = parseFloat(getPosition(e).split(':')[1]);
			mouse_move(e);
		}
		function mouse_move(e)
		{
			var positionx = parseFloat(getPosition(e).split(':')[0]);
			var positiony = parseFloat(getPosition(e).split(':')[1]);
			if (mousestatus) {
				posX+=BigInt(positionx - mouselastX)*posZ/scale;
				posY+=BigInt(positiony - mouselastY)*posZ/scale;
				pr_pos();
			}
			mouselastX = positionx;
			mouselastY = positiony;
		}
		function mouse_up(e)
		{
			if (mousestatus == true)
				pr_pos();
			mousestatus = false;
		}
		function BigIntToStr(n)
		{
			if (n<0)
				return '-'+BigIntToStr(-n);
			if (n % onen==0n)
				return ''+(n / onen);
			return ''+(n/onen)+('.'+(onen+n % onen)).replace(/[0]*$/gi,'').replace('1','');
		}
		function pr_pos()
		{
			//console.log(posX,posY,posZ);
			pool_update();
			pos_text.innerHTML='X: <input type="text" style="vertical-align:middle;width:calc(100% - 50px);" value="'+BigIntToStr(posX)+'"><br>Y: <input style="vertical-align:middle;width:calc(100% - 50px);" type="text" value="'+BigIntToStr(posY)+'"><br>Z: <input style="vertical-align:middle;width:calc(100% - 50px);" type="text" value="'+BigIntToStr(posZ)+'">';
		}
		function pool_update()
		{
			draw_pool=[];
			draw_pool.push([-5n*onen/10n, -5n*onen/10n, onen, onen, "#AAA"]);
			var k=onen/100n;
			while (k>0n)
			{
				draw_pool.push([-5n*onen/10n, -5n*onen/10n, k, k, "#FFF"]);
				draw_pool.push([-5n*onen/10n, -5n*onen/10n, k/10n, k/10n, "#000"]);
				k/=100n;
			}
		}
		var draw_pool=[];
		function render()
		{
			//pos_text.innerHTML='123';
			if (canvas.clientHeight != canvas.height || canvas.clientWidth != canvas.width) {
				canvas.height = canvas.clientHeight;
				canvas.width = canvas.clientWidth;
			}
			scale = BigInt(Math.round(Math.max(canvas.width,canvas.height)));
			ctx.fillStyle = "#4f51bf";
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			for (var i=0;i<draw_pool.length;i++)
			{
				ctx.fillStyle = draw_pool[i][4];
				DrawMyRect(draw_pool[i][0], draw_pool[i][1], draw_pool[i][2], draw_pool[i][3]);
			}
			requestAnimationFrame(render);
		}
		function BigInt2Num(n) {return Number(10000n*n/onen)/10000};
		function DrawMyRect(a, b, c, d, color) {
			ctx.fillRect(BigInt2Num((posX+a)*onen*scale/posZ)+canvas.width/2, BigInt2Num((posY+b)*onen*scale/posZ)+canvas.height/2, BigInt2Num(c*onen*scale/posZ), BigInt2Num(d*onen*scale/posZ));
		}
	</script>
</head>

<body onload="onload()" style="width: 100%;height:100%;font-family: 'Open Sans', sans-serif;">
    <div id="pos" style="width:calc(100% - 20px);height:105px;background:#00047440;position:absolute;z-index:400;margin:10px;top:0px;left:0px;-webkit-user-select: none;user-select: none;">
		<h1 style="color:#fff;font-size:22px;margin: 4px;" id="pos_text"></h1>
	</div>
	<canvas id="canvas" width="1920" height="1080" style="height:100%;width:100%;position: absolute;top: 0%;left: 0%;"></canvas>
</body>
</html>